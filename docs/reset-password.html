<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - GRIN</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pathway+Gothic+One&display=swap" rel="stylesheet">
</head>
<body>
  <header>
      <a href="index.html">
        <img src="GrinLogo.png" alt="GRIN" style="width: 200px; height:auto;">
      <div class="nav-center">
        <nav>
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="issues.html">Issues</a>
          <a href="my_library.html">My Library</a>
          <span id="nav-auth" style="float:right;"></span>
        </nav>
      </div>
  </header>

  <div class="centered-login">
    <h2>Reset Password</h2>
    <form id="reset-password-form" style="display:flex; flex-direction:column; align-items:center; gap:12px; max-width:350px; margin:0 auto;">
      <input type="password" id="new-password" placeholder="New Password" required style="width:100%;" />
  <input type="password" id="confirm-password" placeholder="Confirm New Password" required style="width:100%;" />
  <p id="match-message" style="color:#e63946; font-size:1em; margin:0; min-height:1.2em;"></p>
  <button type="submit" class="paywall-btn" style="width:100%;">Reset Password</button>
  <p id="reset-message" style="margin-top:10px;font-size:1em;"></p>
    </form>
  </div>

  <footer>
    <p>© 2025 GRIN • For the minds of the disturbed</p>
    <script>
      // Show login/signup or logged-in message with email and dropdown for logout
      async function updateNavAuth() {
        const API_BASE_URL = window.location.hostname === "localhost"
          ? "http://localhost:4242"
          : "https://grinzine.fly.dev";
        try {
          const res = await fetch(`${API_BASE_URL}/auth/my-library`, { credentials: "include" });
          if (res.ok) {
            const data = await res.json();
            if (data.email) {
              document.getElementById("nav-auth").innerHTML = `
                <div style="display:inline-block;position:relative;">
                  <span id="user-email" style="cursor:pointer;">Logged in as ${data.email} ▼</span>
                  <div id="logout-dropdown" style="display:none;position:absolute;right:0;background:#fff;color:#333;border:1px solid #ccc;z-index:1000;min-width:120px;">
                    <button id="logout-btn" style="width:100%;padding:8px;border:none;background:none;cursor:pointer;">Logout</button>
                  </div>
                </div>
              `;
              document.getElementById("user-email").onclick = function() {
                const dd = document.getElementById("logout-dropdown");
                dd.style.display = dd.style.display === "block" ? "none" : "block";
              };
              document.getElementById("logout-btn").onclick = async function() {
                await fetch(`${API_BASE_URL}/auth/logout`, { method: "POST", credentials: "include" });
                window.location.href = "login.html";
              };
              document.addEventListener("click", function(e) {
                if (!e.target.closest("#nav-auth")) {
                  document.getElementById("logout-dropdown").style.display = "none";
                }
              });
            } else {
              document.getElementById("nav-auth").textContent = `Logged in`;
            }
          } else {
            throw new Error();
          }
        } catch {
          document.getElementById("nav-auth").innerHTML = `<button class='paywall-btn' onclick=\"window.location.href='login.html'\">Login / Signup</button>`;
        }
      }
      updateNavAuth();

      // Auto-logout after inactivity (30 minutes)
      let logoutTimer;
      function resetLogoutTimer() {
        clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          fetch(`${window.location.hostname === "localhost" ? "http://localhost:4242" : "https://grinzine.fly.dev"}/auth/logout`, { method: "POST", credentials: "include" });
          window.location.href = "login.html";
        }, 30 * 60 * 1000); // 30 minutes
      }
      ["mousemove", "keydown", "click", "scroll", "touchstart"].forEach(evt => {
        window.addEventListener(evt, resetLogoutTimer);
      });
      resetLogoutTimer();
    </script>
    <script>
      // Handle password reset form
      // Live password match check
      document.getElementById("confirm-password").addEventListener("input", function() {
        const password = document.getElementById("new-password").value;
        const confirm = document.getElementById("confirm-password").value;
        const matchMsg = document.getElementById("match-message");
        if (confirm.length === 0) {
          matchMsg.textContent = "";
        } else if (password !== confirm) {
          matchMsg.textContent = "Passwords do not match.";
        } else {
          matchMsg.textContent = "";
        }
      });

      document.getElementById("reset-password-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const password = document.getElementById("new-password").value;
        const confirm = document.getElementById("confirm-password").value;
        if (password !== confirm) {
          document.getElementById("match-message").textContent = "Passwords do not match.";
          return;
        }
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        if (!token) {
          document.getElementById("reset-message").textContent = "Missing or invalid reset token.";
          return;
        }
        const API_BASE_URL = window.location.hostname === "localhost"
          ? "http://localhost:4242"
          : "https://grinzine.fly.dev";
        document.getElementById("reset-message").textContent = "Resetting password...";
        try {
          const res = await fetch(`${API_BASE_URL}/auth/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, password })
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("reset-message").textContent = "Password has been reset. You may now <a href='login.html'>log in</a>.";
          } else {
            document.getElementById("reset-message").textContent = data.error || "Error resetting password.";
          }
        } catch {
          document.getElementById("reset-message").textContent = "Error resetting password.";
        }
      });
    </script>
  </footer>
</body>
</html>
